---
title: "Intermutation distances"
author: Ahmed Hasan
output: pdf_notebook
---

# Import packages

```{r}
library(tidyverse)
library(fs)
library(here)
library(wesanderson)
library(patchwork)
```

# Load in and clean data

```{r}
muts_raw = read_tsv(
  here('data/mutations/mut_describer/muts_described.final.tsv'),
  col_types = cols()
) %>% 
  bind_rows(
    read_tsv(
      here('data/mutations/mut_describer/indels_described.tsv'),
      col_types = cols()
    ) %>% 
      mutate(mut_codon = as.character(mut_codon),
             rho = as.character(rho))
  )

muts_clean = muts_raw %>% 
  
  # remove extra columns
  select(chromosome, position, mutant_sample) %>% 
  
  # add sample and line groups as new cols
  mutate(
    sample_group = str_extract(mutant_sample, '^[A-Z]{2}'),
    line = str_extract(mutant_sample, '[05]$')
  ) %>% 
  
  # sort
  mutate(chrom_val = as.numeric(str_extract(chromosome, '[0-9]{1,2}$'))) %>% 
  arrange(line, chrom_val, sample_group, position)

ma_original = read_tsv(
  here('data/spectrum_context/MA/final.curated_muts.coord_sorted.txt'),
  col_types = cols(), na = c('.')) %>% 
  select(-chromosome_1, -position_1)
  # filter(nchar(mutation) == 3) # remove indels

# for adaptation dataset - see mut_base_spectrum.Rmd
splice_sites = data.frame(
  chromosome = c('chromosome_12', 'chromosome_5', 'chromosome_6', 'chromosome_8'),
  position = c(8771346, 2315498, 2122297, 1131421)
)

adaptation = read_csv(
  here('data/prev/all_mutations_w_shared_hmmIBD_corrected_FPKM.csv'),
  # here('data/prev/all_mutations.csv'),
  col_types = cols(), na = c('.')
) %>% 
  # filter(type == 'SNP') %>% 
  # adding a silent/nonsilent column to the adaptation data frame
  mutate(site_type = case_when(
    Nonsyn_V_Syn == 'synonymous' | intronic == 1 | intergenic == 1 ~ 'silent',
    TRUE ~ 'nonsilent'
  )) %>% 
  mutate(site_type = ifelse(
    chromosome %in% splice_sites$chromosome & position %in% splice_sites$position, 'nonsilent', site_type
  )) # 119 each
```

# Distances

Currently just working off chromosomes - ignoring scaffolds and organelles

## Ungrouped

Intermutation distances across entire mut dataset - no grouping

```{r}
muts_clean %>% 
  arrange(chrom_val, position) %>% 
  group_by(chromosome) %>% 
  
  # get intermut distances
  mutate(next_pos = lead(position)) %>% 
  mutate(d = next_pos - position) %>% 
  
  # remove 'outer boundary' muts
  filter(!is.na(d))
```

## Grouped by line

Intermutation distances in 0 lines and 5 lines, across all sample groups

```{r}
muts_line = muts_clean %>% 
  arrange(line, chrom_val, position) %>% 
  group_by(line, chromosome) %>% 
  
  # get intermut distances
  mutate(next_pos = lead(position)) %>% 
  mutate(d = next_pos - position) %>% 
  
  # remove 'outer boundary' muts
  filter(!is.na(d)) %>% 
  ungroup()

muts_line
```

## Grouped by line and sample group

```{r}
muts_line_group = muts_clean %>% 
  arrange(line, sample_group, chrom_val, position) %>% 
  group_by(line, sample_group, chromosome) %>% 
  
  # get intermut distances
  mutate(next_pos = lead(position)) %>% 
  mutate(d = next_pos - position) %>% 
  
  # remove 'outer boundary' muts
  filter(!is.na(d)) %>% 
  ungroup()

muts_line_group
```

# Kolmogorov-Smirnov tests

## Plots

Across lines - 

```{r}
muts_line %>% 
  ggplot(aes(x = log10(d))) +
  stat_ecdf(aes(color = line)) +
  theme_classic() +
  scale_colour_viridis_d(begin = 0.4, end = 0.6)
```


Across groups and lines:

```{r}
muts_line_group %>% 
  filter(sample_group != 'SL') %>%
  ggplot(aes(x = log10(d))) +
  stat_ecdf(aes(color = sample_group, linetype = line)) +
  theme_classic() +
  scale_colour_viridis_d(begin = 0.4, end = 0.6)
```

## KS tests

### Between 0 and 5

```{r}
ks.test(
  muts_line %>% filter(line == 0) %>% select(d) %>% unlist(),
  muts_line %>% filter(line == 5) %>% select(d) %>% unlist()
)
```


### Between 0 and 5 of the same group

```{r}
ks.test(
  muts_line_group %>% filter(sample_group == 'CC', line == 0) %>% select(d) %>% unlist(),
  muts_line_group %>% filter(sample_group == 'CC', line == 5) %>% select(d) %>% unlist()
)

ks.test(
  muts_line_group %>% filter(sample_group == 'DL', line == 0) %>% select(d) %>% unlist(),
  muts_line_group %>% filter(sample_group == 'DL', line == 5) %>% select(d) %>% unlist()
)
```

### Between sample groups

```{r}
# both of these are significant!
ks.test(
  muts_line_group %>% filter(sample_group == 'CC', line == 0) %>% select(d) %>% unlist(),
  muts_line_group %>% filter(sample_group == 'DL', line == 0) %>% select(d) %>% unlist()
) 

ks.test(
  muts_line_group %>% filter(sample_group == 'CC', line == 5) %>% select(d) %>% unlist(),
  muts_line_group %>% filter(sample_group == 'DL', line == 5) %>% select(d) %>% unlist()
)
```

### Between salt MA and original MA

```{r}
# prepping original MA dataset
ma_orig_distances = ma_original %>% 
  select(chromosome, position, mutant_sample) %>% 
  mutate(chrom_val = as.numeric(str_extract(chromosome, '[0-9]{1,2}$'))) %>% 
  arrange(chrom_val, position) %>% 
  distinct() %>% 
  group_by(chromosome) %>% 
  
  # get intermut distances
  mutate(next_pos = lead(position)) %>% 
  # mutate(next_pos = ifelse(is.na(next_pos), lag(position), next_pos)) %>% 
  mutate(d = next_pos - position) %>% 
  
  # remove 'outer boundary' muts
  # filter(!is.na(d)) %>% 
  ungroup()

# plot
muts_line %>% 
  ggplot(aes(x = log10(d))) +
  stat_ecdf(aes(color = line)) +
  stat_ecdf(data = ma_orig_distances) +
  theme_classic() +
  scale_colour_viridis_d(begin = 0.4, end = 0.8)
```

KS tests:

```{r}
ks.test(
  muts_line %>% filter(line == 0) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)

ks.test(
  muts_line %>% filter(line == 5) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)

ks.test(
  muts_line_group %>% filter(sample_group == 'CC', line == 0) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)

ks.test(
  muts_line_group %>% filter(sample_group == 'CC', line == 5) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)

ks.test(
  muts_line_group %>% filter(sample_group == 'DL', line == 0) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)

ks.test(
  muts_line_group %>% filter(sample_group == 'DL', line == 5) %>% select(d) %>% unlist(),
  ma_orig_distances %>% select(d) %>% unlist()
)
```

## Adaptation dataset

```{r}
# prepping original MA dataset
adaptation_distances = adaptation %>% 
  split(.$site_type) %>% 
  map(
    ~ select(., chromosome, position, mutant_sample, site_type) %>% 
    mutate(chrom_val = as.numeric(str_extract(chromosome, '[0-9]{1,2}$'))) %>% 
    arrange(chrom_val, position) %>% 
    group_by(chromosome) %>% 
    
    # get intermut distances
    mutate(next_pos = lead(position)) %>% 
    mutate(d = next_pos - position) %>% 
    
    # remove 'outer boundary' muts
    filter(!is.na(d)) %>% 
    ungroup()
  )

adaptation_silent = adaptation_distances$silent
adaptation_nonsilent = adaptation_distances$nonsilent
```

Recreating the original Fig 4:

```{r}
ma_orig_distances %>% 
  mutate(site_type = 'ma') %>% 
  bind_rows(adaptation_silent, adaptation_nonsilent) %>% 

ggplot(aes(x = log10(d), color = site_type)) +
  stat_ecdf(size = 1.2, geom = 'line') +
  theme_classic() +
  scale_colour_viridis_d(begin = 0.4, end = 0.8)
```

```{r}
# between MA and silent HS sites
ks.test(
  ma_orig_distances$d, adaptation_silent$d
)

# between silent and nonsilent HS sites
ks.test(
  adaptation_silent$d, adaptation_nonsilent$d
)

# between salt MA and adaptation silent
ks.test(
  muts_line %>% filter(line == 0) %>% select(d) %>% unlist(),
  adaptation_silent$d
)

ks.test(
  muts_line %>% filter(line == 5) %>% select(d) %>% unlist(),
  adaptation_silent$d
)

# between salt MA and adaptation nonsilent
ks.test(
  muts_line %>% filter(line == 0) %>% select(d) %>% unlist(),
  adaptation_nonsilent$d
)

ks.test(
  muts_line %>% filter(line == 5) %>% select(d) %>% unlist(),
  adaptation_nonsilent$d
)
```

# Final combined plot

```{r}
final_distances = muts_line %>% 
  rename(site_type = line) %>% 
  select(
    chromosome, position, mutant_sample,
    chrom_val, next_pos, d, site_type
  ) %>% 
  bind_rows(
    ma_orig_distances %>% mutate(site_type = 'ma'),
    adaptation_silent, 
    adaptation_nonsilent
) %>% 
   mutate(
    site_type = case_when(
      site_type == 'nonsilent' ~ 'HS lines (non-silent sites)',
      site_type == 'silent' ~ 'HS lines (silent sites)',
      site_type == 'ma' ~ 'MA',
      site_type == '0' ~ 'Salt MA (control)',
      site_type == '5' ~ 'Salt MA (salt)'
    )) %>% 
  mutate(
    site_type = fct_relevel(site_type, 
      c('MA', 'HS lines (non-silent sites)', 'HS lines (silent sites)', 
        'Salt MA (control)', 'Salt MA (salt)'))
  )
  

# final_distances = read_tsv(here('data/plots/fig_4a_distances.tsv'), col_types = cols())

distance_cdf_plot = final_distances %>% 
  ggplot(
    aes(x = log10(d), color = site_type)) +
  stat_ecdf(
    size = 1, 
    geom = 'line') +
  scale_color_manual(
    values = wes_palette(
      7, name = 'Darjeeling1', type = 'continuous')[3:7]) +
  labs(
    x = '',
    y = 'Cumulative density'
  ) +
  # legend styling
  theme(
    legend.text = element_text(family = 'Helvetica', color = 'black', size = 10),
    legend.position = c(0.2, 0.8),
    legend.title = element_blank(),
    legend.box.background = element_blank(),
    legend.key = element_blank()
  ) +
  theme(
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, color = 'black'),
    axis.ticks = element_line(size = 0.5, color = 'black'),
    axis.title = element_text(family = 'Helvetica', size = 12, color = 'black'),
    axis.text = element_text(family = 'Helvetica', size = 12, color = 'black'),
    axis.text.x = element_blank() # x axis will be in lower facet
  )

distance_cdf_plot
```

Creating the density plot:

```{r}
final_distances_density = final_distances %>% 
  mutate(
    log_d = log10(d),
    bin = floor(log_d / 0.5) * 0.5) %>% 
  # get density vals
  group_by(
    site_type, bin
  ) %>% 
  summarise(
    n = n()
  ) %>% 
  filter( # remove end of chr mutations
    !is.na(bin), 
    is.finite(bin)) %>% 
  mutate(
    total_group = sum(n)) %>% 
  ungroup() %>% 
  mutate(
    density = n / total_group) 

# add missing values
final_distances_missing = final_distances_density %>% 
  split(.$site_type) %>% 
  map_dfr(
    function(d) {
      bin_range = seq(0, 6.5, 0.5)
      current_vals = unique(d$bin)
      missing_vals = bin_range[
        sapply(bin_range, function(val) !val %in% current_vals)
      ]
      if (length(missing_vals) > 0) {
        vals_to_add = data.frame(
          bin = missing_vals
        )
        vals_to_add$site_type = unique(d$site_type)
        vals_to_add$bin = missing_vals
        vals_to_add$n = 0
        vals_to_add$total_group = unique(d$total_group)
        vals_to_add$density = 0
        vals_to_add = select(vals_to_add, site_type, bin, everything())
        return(vals_to_add)
      }
    }
  )

final_distances_density = bind_rows(
  final_distances_density,
  final_distances_missing
) %>% 
  arrange(site_type, bin)

# write_tsv(final_distances, here('data/plots/fig_4a_distances.tsv'))
# write_tsv(final_distances_density, here('data/plots/fig_4b_density.tsv'))
```
  
Density barplot:

```{r}
# final_distances_density = read_tsv(here('data/plots/fig_4b_density.tsv'), col_types = cols())

distance_density_plot = final_distances_density %>% 
  ggplot(
    aes(x = bin, y = density, fill = site_type)
  ) +
  geom_bar(
    stat = 'identity', 
    position = position_dodge(),
    color = 'black'
  ) +
  guides(fill = FALSE) +
  scale_fill_manual(
    values = wes_palette(
      7, name = 'Darjeeling1', type = 'continuous')[3:7]) +
  labs(
    x = expression(
      paste('Intermutation distance (', log[10], ' bp)')),
    y = 'Proportion',
    tag = 'B'
  ) +
  # legend styling
  theme(
    panel.background = element_blank(),
    axis.line = element_line(size = 0.5, color = 'black'),
    axis.ticks = element_line(size = 0.5, color = 'black'),
    axis.title = element_text(family = 'Helvetica', size = 12, color = 'black'),
    axis.text = element_text(family = 'Helvetica', size = 12, color = 'black')
  )

distance_density_plot
  
```

Combining the two:

```{r}
fig_4 = distance_cdf_plot + distance_density_plot +
  plot_layout(nrow = 2, ncol = 1)

fig_4

ggsave(here('plots/fig_4.eps'), plot = fig_4)
```

